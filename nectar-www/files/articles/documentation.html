

<h2>Basic Request Path Example</h2>

<p>Below you can see a simplified view of how Nectar works when running as an HTTP server. The RequestService (in the center) is responsible for starting up Simple Framework HTTP Server, and processing incoming requests. The DirectoryService determines how request paths are handled, which is configured in the <a href="#pathConfig">config/pathConfig.xml</a> file. The RequestService then builds and validates a Form Object, which holds a predetermined set and range of values (again configured in config/pathConfig.xml). It the creates an Action instance, to which the RequestService feeds the Form. The Action can then interpret the Form, and use any of Nectar's Services to accomplish it's task. Those Services in turn are responsible for saving and storing data. The Action finally returns an <a href="#element">Element</a> object, which contains the resulting data of the Action back to the RequestService. Finally the RequestService feeds that Element's data to the ThymeleafService to plug the data into an HTML template. The resulting HTML is then sent back through HTTP to the client. </p>

<img src="/s/request_arch.png"/>

<p>
This is essentially what just happened when you loaded this very webpage: <a href="http://www.nectarframework.org/documentation">http://www.nectarframework.org/documentation</a> . 
</p>
<p>
You, the Client Web Browser, sent an HTTP request for "/documentation" which Simple's HTTP Server parsed and packaged for the RequestService. Then the RequestService asked the DirectoryService for a definition for the "/documentation" path, which returned a redirect to "/articleView?id=3" (check it out: <a href="http://www.nectarframework.org/articleView?id=3">http://www.nectarframework.org/articleView?id=3</a> is exactly the same page as this one!). This page isn't static HTML, it's actually a chunk of HTML and text in a database plugged into a template. The RequestService then continued searching for the path articleView, and the DirectoryService returned an Action and Form definition to match it. All this was defined the <a href="#pathConfig">config/pathConfig.xml</a> :
<pre>
&lt;pathConfig&gt;
	&lt;project namespace=&quot;&quot;&gt;
	&lt;redirect path=&quot;documentation&quot; toPath=&quot;articleView&quot;&gt;
			&lt;var name=&quot;id&quot; value=&quot;3&quot;/&gt;
	&lt;/redirect&gt;
	&lt;path path=&quot;articleView&quot; action=&quot;articleView&quot; /&gt;
	&lt;action name=&quot;articleView&quot; package=&quot;org.nectarframework.www.action&quot;
			class=&quot;ArticleViewAction&quot; form=&quot;articleView&quot; defaultOutput=&quot;thymeleaf&quot;
			templateName=&quot;articleView&quot; /&gt;
	&lt;form name=&quot;articleView&quot;&gt;
			&lt;var name=&quot;id&quot; type=&quot;int&quot; required=&quot;true&quot; minValue=&quot;0&quot;/&gt;
	&lt;/form&gt;
	...
	&lt;/project&gt;
&lt;/pathConfig&gt;
</pre>

The Form Object for this action only has one variable, called "id". That value must be an integer greater than zero, and it must be defined, or the server will throw an HTTP 400 error: try these links: <a href="http://www.nectarframework.org/articleView?id=socks">http://www.nectarframework.org/articleView?id=socks</a>  <a href="http://www.nectarframework.org/articleView">http://www.nectarframework.org/articleView</a>. 

And here's the Action implementation in full:

<pre>
package org.nectarframework.www.action;

import org.nectarframework.base.service.log.Log;
import org.nectarframework.base.service.xml.Element;
import org.nectarframework.www.data.Article;

public class ArticleViewAction extends BaseAction {

	@Override
	public Element _execute() {
		// get the ID from the Form Object
		Integer id = form.getInt("id");

		// Article is is a DataStoreObject, so the below is all you need to load
		// it from the database
		Article article;
		try {
			// lots of magic happens in the load method, see DataStoreService
			// documentation!
			article = Article.load(id);
		} catch (Exception e) {
			// save the error in the logging system.
			Log.warn(e);
			// returning null will tell the RequestService not to proceed, and
			// spit out an error message instead.
			return null;
		}

		// Creating the output Element. As a tradition it's named after the
		// Action name, but that's not obligatory.
		Element elm = new Element("arcticleView");

		// Article ID wasn't found in the database, so display an empty page.
		if (article == null) {
			return elm;
		}

		// copy the DataStoreObject's data into the output Element
		elm.add("name", article.getName());
		elm.add("content", article.getContent());

		return elm;
	}

}
</pre>

That Element is then fed back through the RequestService into the Thymeleaf template engine, and we pick up the content attribute of the Element in the files/thymeleaf_templates/articleView.html like this:

<pre>
	...
	&lt;div class=&quot;content&quot; th:utext=&quot;${arcticleView.content}&quot;&gt;&lt;/div&gt;
	...
</pre>

Thymeleaf then produces an HTML document, which the RequestService finally converts into a byte array and shoves it back down the line to you as a HTTP Response. 
</p>




</p>

<h2>Nectar-base Service Stack</h2>

<img src="/s/service_stack.png"/>


<h2>Running and Configuring Nectar</h2>

<h3>Requirements</h3>

<p>If you simply want to get something running to see if it works, you'll need a Java SE 8 JRE and this download, which contains all the required libraries: TODO link here.</p>
<p>On Ubuntu 16.04:
<pre>
sudo apt install openjdk8* 
sudo adduser nectar --disabled-password --disabled-login
sudo su - nectar
wget **TODO-insert-link**
tar -zxf **TODO-file**
cd bla 
sh run_nectar.sh
</pre>
</p>
<p>If you want to keep up to date with Nectar's development, you should set up a Git / Maven build environment. </p>
<p>On Ubuntu 16.04:
<pre>
sudo apt install openjdk8* maven maven* git
sudo adduser nectar --disabled-password --disabled-login
sudo su - nectar
git clone https://github.com/schuttek/nectar.git
cd nectar/nectar-base
mvn clean test install
cd ../nectar-www
mvn clean test install
</pre>

Then set up a separate directory for the server itself and copy the necessary files.
<pre>
cd /home/nectar
mkdir -p nectar_server
cp nectar/nectar-www/target/nectar-www-0.0.1.jar nectar_server/
rm -rf nectar-server/files
cp -r nectar/nectar-www/files nectar_server/
cp nectar/nectar-www/config/dataStoreObjects.xml nectar_server/config/
cp nectar/nectar-www/config/pathConfig.xml nectar_server/config/
</pre>

Finally run the server: 
<pre>
cd nectar_server
java -cp nectar-www-0.0.1.jar org.nectarframework.base.Main -c config/config.xml -g nodeGroup1 -n serverName1

</p>


<h3>Running Nectar</h3>
<p>The main entry point is <code>org.nectarframework.base.Main.main(String[] args);</code> in the nectar-base.x.y.z.jar file.</p>
<p>The main and required command line arguments are: </p>
<pre>
 -c,--configFile <PATH>   path to the configuration XML file
 -g,--nodeGroup <GROUP>   the run mode to use, as described in the config
                          file
 -n,--nodeName <NAME>     give this instance a name
</pre>
<p> The configFile determines which Services should be loaded, and defines configuration variables for each Service. A configFile can define multiple node group types, which allow you to configure multiple nectar instances in a single config file. The nodeGroup argument determines which node group configuration the instance you're launching should use. Finally, the nodeName allows you to uniquely identify an instance of Nectar even when running several instances of the same node group. </p>


<h2>Configuration</h2>

<h3>config/config.xml</h3>

<h3>config/dataStoreObjects.xml</h3>

<h3>config/pathConfig.xml</h3>


<h1>Troubleshooting</h1>

<h3>SimpleHttpRequestService can't open port 80</h3>
<p>SimpleHttpRequestService can't open port 80 as listening port while running as nectar user on Linux. Unless you want to run Nectar as root (which is NOT recommended), you need to configure iptables to reroute port 80 to another port which the nectar user can open: 
<pre>
iptables -t mangle -A PREROUTING -p tcp --dport 80 -j MARK --set-mark 1
iptables -t mangle -A PREROUTING -p tcp --dport 443 -j MARK --set-mark 1
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 8181
iptables -I INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -m mark --mark 1 -j ACCEPT
iptables -I INPUT -m state --state NEW -m tcp -p tcp --dport 8181 -m mark --mark 1 -j ACCEPT
</pre>
</p>

